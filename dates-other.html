<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Filters</title>

<style>
  body {
    display: flex;
    font-family: "Avenir Next W01", "Avenir Next", Avenir, "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 16px;
  }
  
  html,
  body,
  #viewDiv {
    height: 100%;
    width: 100%;
    padding: 0;
    margin: 0;
    flex: auto;
  }
  
  #sidebar {
    width: 350px;
    height: 100%;
    padding: 10px;
    flex: auto;
  }
  
  #histogram {
    height: 200px;
  }
  
  #timeslider {
    height: 200px;
  }
  
  #sidebarItems {
    display: flex;
    flex-direction: column;
  }
  
  #sidebarItems > * {
    flex: auto;
    padding-bottom: 10px;
  }

  #sidebarItems:first-child {
    padding-top: 10px;
  }
  
  #datasetName {
    font-size: 24px;
  }

</style>

<!-- calcite components -->
<script
  type="module"
  src="https://unpkg.com/@esri/calcite-components@1.0.0-beta.24/dist/calcite/calcite.esm.js"
></script>
<link
  rel="stylesheet"
  type="text/css"
  href="https://unpkg.com/@esri/calcite-components@1.0.0-beta.24/dist/calcite/calcite.css"
/>
    
<script type="module">

  import { loadModules, setDefaultOptions } from 'https://unpkg.com/esri-loader/dist/esm/esri-loader.js';
  
  (async () => {

    setDefaultOptions({
      css: true,
      // url: 'http://localhost:8000/buildOutput/init.js',
      // version: 'next',
    });

    const [Map, MapView, FeatureLayer, TimeSlider] = await loadModules([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/widgets/TimeSlider"
    ]);



    // URL params
    const params = new URLSearchParams(window.location.search);
    const datasetId = params.get('dataset');
    const env = params.get('env') || 'prod';

    const { layer, dataset } = await loadDataset({ datasetId, env });
    
    const map = new Map({
      basemap: "dark-gray-vector",
      layers: [layer]
    });

    const view = new MapView({
      container: "viewDiv",
      map: map,
      extent: getDatasetExtent(dataset)
    });
    
    const layerView = await view.whenLayerView(layer);
    
    // Dataset info
    document.querySelector('#datasetName').innerHTML = dataset.attributes.name;
    document.querySelector('#orgName').innerHTML = dataset.attributes.orgName || '';
    
    // const { timeSliderUI } = await createTimeSlider(fieldName, layer, 'timeslider');
    const { timeSliderUI } = await createTimeSlider('timeslider');
    if (timeSliderUI) {
    const fieldName = "DATEUTC"
    timeSliderUI.watch("timeExtent", function(value){
        // update layer view filter to reflect current timeExtent
        layerView.filter = {
            where: `${fieldName} BETWEEN ${value.start} AND ${value.end}`
            // timeExtent: value
        };
    });

    }

        
    // put vars on window for debugging
    Object.assign(window, { view, map, dataset, layer, layerView, TimeSlider });

    
    async function loadDataset ({ datasetId, env }) {
      // https://opendataqa.arcgis.com/api/v3/datasets/97a641ac39904f349fb5fc25b94207f6
      const datasetURL = `https://opendata${env === 'qa' ? 'qa' : ''}.arcgis.com/api/v3/datasets/${datasetId}`;
      let dataset = {};
      try {
        dataset = (await fetch(datasetURL).then(r => r.json())).data;
      } catch(e) {}
      
//       let symbol = {
//         color: [51, 51, 204, 0.9],
//         outline: {
//           color: 'white',
//           width: 0.5
//         }
//       }
      
//       if (geometryType === 'point') {
//         symbol = { ...symbol, type: 'simple-marker', size: '8px' };
//       }
//       else if (geometryType === 'polyline') {
//         symbol = { ...symbol, type: 'simple-line', width: '4px' };
//       }
//       else if (geometryType === 'polygon') {
//         symbol = { ...symbol, type: 'simple-fill' };
//       }
      
      const layer = new FeatureLayer({
        // renderer: { type: 'simple', symbol },
        url: dataset.attributes.url
      });

      layer.minScale = 0; // draw at all scales
      
      return { dataset, layer };
    }
    
    function getDatasetExtent (dataset) {
      const extent = dataset.attributes.extent;
      return {
        xmin: extent.coordinates[0][0],
        ymin: extent.coordinates[0][1],
        xmax: extent.coordinates[1][0],
        ymax: extent.coordinates[1][1],
        spatialReference: extent.spatialReference
      };
    }

    function updateAttributeList (dataset) {
      // Attribute dropdown (numeric attributes only right now)
      // create <calcite-dropdown-item> for each attribute    
      const attributeList = document.querySelector('#attributeList > calcite-dropdown-group');
      // let entries = Object.entries(dataset.attributes.statistics.numeric);
      // let dates = Object.entries(dataset.attributes.statistics.date);

      // entries = entries.filter(
      //   ( [fieldName, fieldStats] ) =>
      //   fieldStats.min!== fieldStats.max); // exclude fields with one value
      // entries = entries.map(([fieldName, { statistics: { values: fieldStats } }]) => [fieldName, fieldStats]); // grab stats
      // entries = entries.filter(([fieldName, fieldStats]) => fieldStats.min!== fieldStats.max); // exclude fields with one value
      // entries.forEach(([fieldName, fieldStats]) => {
      //     const fieldInfo = dataset.attributes.fields.find(f => f.name.toLowerCase() === fieldName.toLowerCase());

      //     // const item = document.createElement('calcite-dropdown-item');
      //     item.innerHTML = `${fieldInfo.alias} (${fieldStats.min } - ${fieldStats.max})`;
      //     item.setAttribute('data-field', fieldInfo.name);
      //     // attributeList.appendChild(item);
      //   });

      // let mapped = dates.map(([fieldName, { statistics: { values: fieldStats } }]) => [fieldName, fieldStats]); // grab stats
      // let filtered = mapped.filter(
      //   ( [fieldName, fieldStats] ) =>
      //   fieldStats.min!== fieldStats.max); // exclude fields with one value
      // let finals = filtered.filter(([fieldName, fieldStats]) => fieldStats.min!== fieldStats.max); // exclude fields with one value
      let finals = dataset.attributes.fields;
      finals.forEach(([fieldName, fieldStats]) => {
          const fieldInfo = dataset.attributes.fields.find(f => f.name.toLowerCase() === fieldName.toLowerCase());

          const item = document.createElement('calcite-dropdown-item');
          item.innerHTML = `${fieldInfo.alias} (${fieldStats.min } - ${fieldStats.max})`;
          item.setAttribute('data-field', fieldInfo.name);
          attributeList.appendChild(item);
        });

      return attributeList;
    }

    // async function createTimeSlider (field, layer, container) {
    async function createTimeSlider (container) {
      try {        
        let startDate = 1400544000000;
        let endDate = 1560902400000;
        startDate = new Date(startDate)
        endDate = new Date(endDate)

        const timeSliderUI = new TimeSlider({
          container: container,
        //   view: view,
          mode: "time-window",
          fullTimeExtent: {
            start: startDate,
            end: endDate,
          },
          values: [
            startDate,
            endDate
          ],
        });

        return { timeSliderUI };
      }
      catch(e) {
        console.log(e);
        return {};
      }
    }
    
    function createSlider (field, layer, container) {
      // <calcite-slider
      //   min="1"
      //   max="100"
      //   minValue="50"
      //   maxValue="85"
      //   step="1"
      //   min-label="Temperature (lower)"
      //   max-label="Temperature (upper)"
      // ></calcite-slider>
    }
    
  })();
</script>
</head>

  <body>
    <div id="sidebar">
      <div id="sidebarItems">
        <div id="datasetName"></div>
        <div id="orgName"></div>
      
        <calcite-dropdown type="hover" id="attributeList">
         <calcite-button id="attributeListButton" slot="dropdown-trigger">Choose an attribute</calcite-button>
         <calcite-dropdown-group>
         </calcite-dropdown-group>
        </calcite-dropdown>    

        <div id="timeslider"></div>
      
      </div>
    </div>
    <div id="viewDiv"></div>        
  </body>
</html>
